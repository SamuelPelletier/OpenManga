{% extends 'base.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('css/show') }}
{% endblock %}

{% block title %}{{ manga.title }}{% endblock %}

{% block meta_description %}
    {{ parent() }}
    {{ 'meta.description.manga'|trans ~ manga.title | raw  ~ 'meta.description.with'|trans }} {{ manga.tags | join(',',' and ') }}
{% endblock %}

{% block meta_keyword %}
    {% if manga.tags.count > 0 %}
        {{ manga.tags | join(',') }}
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock %}

{% block main %}
    <h1>{{ manga.title | raw }}</h1>
    <p class="manga-metadata">
    <span class="metadata"><i class="fa fa-calendar-alt"></i> {{ manga.publishedAt|format_datetime('long', 'none') }}</span>
    </p>
    {% if not manga.languages.empty %}
        <p>
            <a>{{ 'manga.language'|trans }} : </a>
            {% for language in manga.languages %}
                <span class="label-container">
                    <a href="{{ url('search', {'q': language.name == app.request.query.get('language') ? null : language.name, 's':true}) }}"
                    class="label label-{{ language.name == app.request.query.get('language') ? 'success' : 'default' }}"
                    >
                        <span class="fi fi-{{ language.code }}"></span>
                        <i class="fa fa-language"></i> {{ language.name }}
                        <i> {{ mangaRepository.countByLanguage(language) }}</i>

                    </a>
                </span>
            {% endfor %}
        </p>
    {% endif %}
    {% if not manga.parodies.empty %}
        <p>
            <a>{{ 'manga.parody'|trans }} : </a>
            {% for parody in manga.parodies %}
                <span class="label-container">
                    <a href="{{ url('search', {'q': parody.name == app.request.query.get('parody') ? null : parody.name, 's':true}) }}"
                    class="label label-{{ parody.name == app.request.query.get('parody') ? 'success' : 'default' }}"
                    >
                        <i class="fa fa-folder"></i> {{ parody.name }}
                    <i> {{ mangaRepository.countByParody(parody) }}</i>

                    </a>
                </span>
            {% endfor %}
        </p>
    {% endif %}
    
    {% if not manga.authors.empty %}
        <p>
            <a>{{ 'manga.author'|trans }} : </a>
            {% for author in manga.authors %}
                <span class="label-container">
                    <a href="{{ url('search', {'q': author.name == app.request.query.get('author') ? null : author.name, 's':true}) }}"
                    class="label label-{{ author.name == app.request.query.get('author') ? 'success' : 'default' }}"
                    >
                        <i class="fa fa-user"></i> {{ author.name }}
                    <i>{{ mangaRepository.countByAuthor(author) }}</i>
                    </a>
                </span>
            {% endfor %}
        </p>
    {% endif %}
    <p class="count-views">{{ 'manga.count_views'|trans }} : {{ manga.countViews }}<i class="fa fa-eye"></i></p>
    {% if not manga.tags.empty %}
        <p>
            <a>{{ 'manga.tag'|trans }} : </a>
            <div class="tags">
            <center>
                {% for tag in manga.tags %}
                    <span class="label-container">
                        <a href="{{ url('search', {'q': tag.name == app.request.query.get('tag') ? null : tag.name, 's':true}) }}" class="label label-default">
                            {{ tag.name }}
                            <i class="counter label ">{{ mangaRepository.countByTag(tag) }}</i>
                        </a>
                    </span>
                {% endfor %}
            </div>
            </center>
        </p>
    {% endif %}
    <a class="btn-effect raise download" target="_blank" href="{{ url('download', {'id':manga.id}) }}"><i class="fa fa-download "></i>{{'manga.download'|trans }}</a>
    
    <a class="btn-effect raise download translationButton" href="{{ url('translate', {'id':manga.id}) }}"><i class="fa fa-download "></i>(beta) download auto translation</a>
    {% if translations is not empty %}

        <a class="btn-effect raise download translationButton">
        <span class="fi fi-fr"></span>shw auto translation</a>
    {% endif %}

    {% if app.user is not null %}
        {% if manga in app.user.getFavoriteMangas %}
            {% set buttonText = 'manga.remove_favorite'|trans %}
            {% set url = url('remove_favorite',{"id":manga.id}) %}
        {% else %}
            {% set buttonText = 'manga.add_favorite'|trans %}
            {% set url = url('add_favorite',{"id":manga.id}) %}
        {% endif %}

        <a class="btn-effect offset add-favorite"
        data-url="{{ url }}"><i class="fa fa-star"> </i>{{ buttonText }}</a>

    {% endif %}
    

    <div class="row" id="lightgallery">
        {% for image in images %}
            {% if image matches '{\.jpg$}' %}
                <article class="image col-sm-3"
                         data-src='{{ app.request.getSchemeAndHttpHost() ~ asset( 'media/' ~ manga.id ~ '/' ~ image ) }}'
                         data-sub-html="<div class='lightGallery-captions'> <h4>Photo by - <a href='https://unsplash.com/@entrycube' >Diego Guzm√°n </a></h4> <p> Location - <a href='https://unsplash.com/s/photos/fushimi-inari-taisha-shrine-senbontorii%2C-68%E7%95%AA%E5%9C%B0-fukakusa-yabunouchicho%2C-fushimi-ward%2C-kyoto%2C-japan'>Fushimi Ward, Kyoto, Japan</a></p></div>">

                    <img alt="{{ manga.title | raw }} {{ 'manga.image_alt'|trans({'%count%':loop.index}) }}"
                         title="{{ manga.title | raw }} {{ 'manga.image_alt'|trans({'%count%':loop.index}) }}"
                         class='img-view'
                         src='{{ app.request.getSchemeAndHttpHost() ~ asset( 'media/' ~ manga.id ~ '/' ~ image ) }}'>
                    {% if translations[image] is defined %}
                        

                        {% for translation in translations[image] %}
                            {# set fontsize = (area ** 0.5) / 10 | round(0, 'floor') #} 
                            {# Calculate the maximum font size that fits the text inside the box #}
                            <div   class="translation-overlay" style="font-size: 10px !important; left: {{ translation.x * 100 }}%; top: {{ translation.y * 100 }}%; width: {{ translation.w * 100 }}%; height: {{ translation.h * 100 }}%; overflow: hidden;">
                                <p>{{ translation.translated_text | raw }}</p>
                            </div>

                        {% endfor %}
                    {% endif %}
                </article>
            {% endif %}
        {% else %}
            <div class="well">{{ 'manga.no_images_found'|trans }}</div>
        {% endfor %}
    </div>
    {% if mangas_recommended is not empty %}
        <div id="recommended">
            <h2>{{ 'manga.recommended'|trans }}</h2>
            <div class="manga-recommended-container">
                {% for manga in mangas_recommended %}
                    <article class="manga col-sm-3">
                        <div class="thumbnail-tag">
                            {% if not manga.tags.empty %}
                                {% for tag in manga.tags|slice(0,5) %}
                                    <a href="{{ url('search', {'q': tag.name == app.request.query.get('tag') ? null : tag.name, 's':true}) }}"
                                    totalx="158" draggable="false">
                                        <span class="tag-rounded" totalx="158">{{ tag.name }}</span>
                                    </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <a href="{{ url('manga', {id: manga.id}) }}">
                            <p class="manga-count-pages">
                                {% for language in manga.languages %}
                                    {% if language.code %}
                                        <span class="fi fi-{{ language.code }}"></span>
                                    {% endif %}
                                {% endfor %}
                                {{ manga.countPages }} <i class="fa-regular fa-images"></i>
                            </p>
                            <div class="image-container">
                                <img alt="{{ manga.title |raw }}" title="{{ manga.title |raw }}" class='img-thumbnail'
                                    src='{{ app.request.getSchemeAndHttpHost() ~ asset( 'media/' ~ manga.id ~ '/thumb.webp' ) }}'>
                            </div>
                            <div class="img-name">
                                <h2>{{ manga.title |raw }}</h2>
                            </div>
                        </a>
                    </article>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% block javascripts %}
        {{ parent() }}
        {{ encore_entry_script_tags('show') }}
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebPage",
                "breadcrumb": "Books > Manga",
                "mainEntity": {
                    "@type": "Book",
                    "author": "{{ manga.authors|join(',') }}",
                    "bookFormat": "http://schema.org/EBook",
                    "datePublished": "{{ manga.publishedAt|format_datetime('long', 'none', 'UTC') }}",
                    "image": "{{ app.request.getSchemeAndHttpHost() ~ asset( 'media/' ~ manga.id ~ '/thumb.webp' ) }}",
                    "inLanguage": "{{ manga.languages|join(',') }}",
                    "name": "{{ manga.title }}",
                    "numberOfPages": "{{ manga.countPages }}",
                    "publisher": "{{ app.request.server.get('APP_NAME') }}",
                    "aggregateRating": {
                        "@type": "AggregateRating",
                        "reviewCount": "{{ manga.countViews }}",
                        "ratingValue": "5"
                    }
                }
            }
        </script>
    {% endblock %}
{% endblock %}